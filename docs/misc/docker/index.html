<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Виртуализация #  Типы виртуализации:
 эмуляция железа - использует ВИ для симуляции требуемого железа  pros: теоретически можно запустить любой софт на любом виртуальном железе cons: очень медленно    +----------+----------+----------+----------+ | Apps | Apps | Apps | Apps | +----------+----------+----------+----------+ | Guest OS | Guest OS | Guest OS | Guest OS | +----------+----------+----------+----------+ | Hardware VM A | Hardware VM B | +---------------------+---------------------+ | Hardware | +---------------------+---------------------+   полная виртуализация"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Основы Docker"><meta property="og:description" content="Виртуализация #  Типы виртуализации:
 эмуляция железа - использует ВИ для симуляции требуемого железа  pros: теоретически можно запустить любой софт на любом виртуальном железе cons: очень медленно    +----------+----------+----------+----------+ | Apps | Apps | Apps | Apps | +----------+----------+----------+----------+ | Guest OS | Guest OS | Guest OS | Guest OS | +----------+----------+----------+----------+ | Hardware VM A | Hardware VM B | +---------------------+---------------------+ | Hardware | +---------------------+---------------------+   полная виртуализация"><meta property="og:type" content="article"><meta property="og:url" content="https://morggoth.github.io/docs/misc/docker/"><meta property="article:published_time" content="2021-03-31T00:02:58+03:00"><meta property="article:modified_time" content="2021-03-31T00:02:58+03:00"><title>Основы Docker | Morggoth's wiki</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY="><script defer src=/en.search.min.868d001c2b13c2c9b7ad8df750387f743437ab6a93171a26f60958a63969a0c6.js integrity="sha256-ho0AHCsTwsm3rY33UDh/dDQ3q2qTFxom9glYpjlpoMY="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>Morggoth's wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/cloud/ class=collapsed>Cloud</a></li><li><a href=/docs/k8s/ class=collapsed>Kubernetes</a></li><li><a href=/docs/mooc/ class=collapsed>Courses notes</a></li><li><a href=/docs/misc/prometheus/>Prometheus</a></li><li><a href=/docs/misc/docker/ class=active>Основы Docker</a></li><li><a href=/docs/misc/cheatsheets/>Cheatsheets</a></li><li><a href=/docs/misc/rpi/>Raspberry Pi</a></li><li><a href=/docs/misc/kafka/>Kafka basics</a></li><li><a href=/docs/misc/old_hardware/>Old hardware</a></li><li><a href=/docs/languages/ class=collapsed>Languages</a></li><li><a href=/docs/misc/chromeos/>ChromeOS</a></li><li><a href=/docs/misc/macos/>macOS</a></li><li><a href=/docs/misc/mikrotik/>Mikrotik</a></li><li><a href=/docs/misc/tips_and_tricks/>Tips & Tricks</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Основы Docker</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#виртуализация>Виртуализация</a></li><li><a href=#технологии-на-которых-основана-контейнеризация>Технологии, на которых основана контейнеризация</a><ul><li><a href=#cgroups>CGroups</a></li><li><a href=#namespaces>Namespaces</a></li></ul></li><li><a href=#фс-для-контейнеров>ФС для контейнеров</a></li><li><a href=#docker-image>Docker image</a></li><li><a href=#полезные-команды>Полезные команды</a></li><li><a href=#сборка-образа>Сборка образа</a></li><li><a href=#работа-с-локальным-реджистри>Работа с локальным реджистри</a></li><li><a href=#docker-machine>Docker Machine</a></li></ul></nav></aside></header><article class=markdown><h2 id=виртуализация>Виртуализация
<a class=anchor href=#%d0%b2%d0%b8%d1%80%d1%82%d1%83%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f>#</a></h2><p>Типы виртуализации:</p><ul><li>эмуляция железа - использует ВИ для симуляции требуемого железа<ul><li>pros: теоретически можно запустить любой софт на любом виртуальном железе</li><li>cons: очень медленно</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>
    +----------+----------+----------+----------+
    |   Apps   |   Apps   |   Apps   |   Apps   |
    +----------+----------+----------+----------+
    | Guest OS | Guest OS | Guest OS | Guest OS |
    +----------+----------+----------+----------+
    |    Hardware VM A    |    Hardware VM B    |
    +---------------------+---------------------+
    |                  Hardware                 |
    +---------------------+---------------------+

</code></pre></div><ul><li><p>полная виртуализация</p><ul><li>использует гипервизор для предоставления ВМ нижележащего физического железа</li><li>в этом случае запускаемая на ВМ ОС должна иметь ту же архитектуру</li><li>гипервизор может быть:<ul><li>приложением</li><li>частью ядра ОС</li><li>самостоятельной ОС</li></ul></li><li>примеры:<ul><li>KVM+QEMU</li><li>Xen</li><li>VirtualBox</li><li>VMware</li><li>Parallels</li><li>MS HyperV</li></ul></li></ul></li><li><p>пара-виртуализация</p><ul><li>разделение процессов с гостевой ОС</li><li>могут использоваться различные ядра</li><li>у ядра гостевой ОС есть модуль, который позволяет часть системный вызовов выполнять на хостовой ОС</li></ul></li><li><p>изоляция/контейнеризация</p><ul><li>запуск некоторых процессов в изолированной среде на той же самой ОС</li><li>мнение: просто новый способ запуска задач (процессов) в ОС</li><li>примеры:<ul><li>Docker</li><li>Sandbox</li><li>OpenVZ</li><li>LXC</li><li>Singularity (для использования не нужны root права)</li></ul></li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>
    +------------------------------------------------------------+
    | Private Zone |  Private Zone |      ...     | Private Zone |
    +------------------------------------------------------------+
    |                    Operating System (host)                 |
    +------------------------------------------------------------+
    |                            Hardware                        |
    +------------------------------------------------------------+

</code></pre></div><p>LXC - одна из первых реализаций контейнеров под Linux (вроде как родом из Google, проверить).</p><h2 id=технологии-на-которых-основана-контейнеризация>Технологии, на которых основана контейнеризация
<a class=anchor href=#%d1%82%d0%b5%d1%85%d0%bd%d0%be%d0%bb%d0%be%d0%b3%d0%b8%d0%b8-%d0%bd%d0%b0-%d0%ba%d0%be%d1%82%d0%be%d1%80%d1%8b%d1%85-%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b0%d0%bd%d0%b0-%d0%ba%d0%be%d0%bd%d1%82%d0%b5%d0%b9%d0%bd%d0%b5%d1%80%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f>#</a></h2><h3 id=cgroups>CGroups
<a class=anchor href=#cgroups>#</a></h3><p>Механизм ядра, позволяющий:</p><ul><li>изолировать</li><li>приоритизировать</li><li>управлять</li><li>рассчитывать</li></ul><p>ресурсы, доступные системе.</p><p>Основные ресурсы:</p><ul><li>CPU<ul><li>ядра</li><li>процессорное время</li></ul></li><li>memory</li><li>disk I/O</li><li>network I/O</li></ul><p>Задачи, выполняемые CGroup:</p><ul><li>ограничение ресурсов для группы процессов</li><li>приоритизировать группы процессов относительно количества доступных ресурсов</li><li>учитывать ресурсы, которые были потреблены той или иной группой процессов</li><li>управлять группой процессов, замораживая, восстанавливая или перезапуская ее</li></ul><h3 id=namespaces>Namespaces
<a class=anchor href=#namespaces>#</a></h3><p>Позволяет ограничить возможность взаимодействия процессов с процессами и иными ресурсами, принадлежащими другой группе (другому пространству имен).</p><ul><li>PID (процесс в таком NS имеет 2 PID - один из хостовой системы, второй из самого NS; при этом другие процессы того же NS могут узнать только второй)</li><li>FS (mount; прародителем этого типа изоляции был <em>chroot</em>)</li><li>UTS</li><li>network</li><li>SysV IPC</li></ul><h2 id=фс-для-контейнеров>ФС для контейнеров
<a class=anchor href=#%d1%84%d1%81-%d0%b4%d0%bb%d1%8f-%d0%ba%d0%be%d0%bd%d1%82%d0%b5%d0%b9%d0%bd%d0%b5%d1%80%d0%be%d0%b2>#</a></h2><p>ФС самого контейнера, именно на этом уровне реализуется многослойность. Каждый слой образа - RO.</p><p>При запуске контейнера из этого образа добавляется еще один слой, который уже доступен RW. Этот слой существует только в момент жизни контейнера, как только контейнер удаляется, все данные из внешнего слоя так же удаляются.</p><h2 id=docker-image>Docker image
<a class=anchor href=#docker-image>#</a></h2><p>Схема имени образа:</p><p>[host][:port]/[repository]/&lt;image-name>[:tag]</p><p>Если:</p><ul><li><em>host</em> не указан, то по умолчанию подразумевается hub.docker.com, однако это можно изменить в настройках Docker демона.</li><li>на hub.docker.com в адресе образа отсутствует <em>repository</em> (<em>username</em> в случае именно этого ресурса), это значит, что образ официальный.</li><li><em>tag</em> не указан, но подразумевается <em>latest</em>.</li></ul><h2 id=полезные-команды>Полезные команды
<a class=anchor href=#%d0%bf%d0%be%d0%bb%d0%b5%d0%b7%d0%bd%d1%8b%d0%b5-%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d1%8b>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Последовательность, позволяющая отключиться от контейнера, не прерывая его работу</span>
^p^q

<span style=color:#75715e># Запуск остановленного контейнера</span>
docker start <span style=color:#e6db74>${</span>CONTAINER_ID<span style=color:#e6db74>}</span>

<span style=color:#75715e># Подключение к запущенному контейнеру</span>
docker attach <span style=color:#e6db74>${</span>CONTAINER_ID<span style=color:#e6db74>}</span>

<span style=color:#75715e># Добавление таймштампов к логу</span>
docker logs -t <span style=color:#e6db74>${</span>CONTAINER_ID<span style=color:#e6db74>}</span>

<span style=color:#75715e># Сравнение текущего RW слоя контейнера с образом</span>
docker diff <span style=color:#e6db74>${</span>CONTAINER_ID<span style=color:#e6db74>}</span>

<span style=color:#75715e># Показывает системные PID`ы процессов, запущенных в контейнере</span>
docker top

<span style=color:#75715e># Показывает все контейнеры в системе и ресурсы, которые они потребляют</span>
docker stats

<span style=color:#75715e># Создает tar-архив из ФС контейнера и подает его на stdout</span>
docker export

<span style=color:#75715e># Создает образ из tar-архива</span>
docker import

<span style=color:#75715e># Показывает историю изменений образа</span>
docker history
</code></pre></div><h2 id=сборка-образа>Сборка образа
<a class=anchor href=#%d1%81%d0%b1%d0%be%d1%80%d0%ba%d0%b0-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b0>#</a></h2><p>На каждую строчку Dockerfile запускается контейнер и в нем выполняется инструкция. Если при этом был изменен верхний (RW) слой контейнера, происходит <code>docker commit</code>, тем самым, создаётся новый слой образа.</p><p>Директива <code>ADD</code> умеет распаковывать tar-архивы и копировать в образ удаленные файлы (при этом не поддерживается распаковка).</p><h2 id=работа-с-локальным-реджистри>Работа с локальным реджистри
<a class=anchor href=#%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0-%d1%81-%d0%bb%d0%be%d0%ba%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%bc-%d1%80%d0%b5%d0%b4%d0%b6%d0%b8%d1%81%d1%82%d1%80%d0%b8>#</a></h2><p>Для отправки контейнера в локальный (кастомный) реджистри, нужно добавить ему тег с именем реджистри, после чего выполнить <code>docker push</code>.</p><h2 id=docker-machine>Docker Machine
<a class=anchor href=#docker-machine>#</a></h2><p>Средство оркестрации, позволяющее управлять Docker-демонами на удаленных машинах с использованием REST API.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#виртуализация>Виртуализация</a></li><li><a href=#технологии-на-которых-основана-контейнеризация>Технологии, на которых основана контейнеризация</a><ul><li><a href=#cgroups>CGroups</a></li><li><a href=#namespaces>Namespaces</a></li></ul></li><li><a href=#фс-для-контейнеров>ФС для контейнеров</a></li><li><a href=#docker-image>Docker image</a></li><li><a href=#полезные-команды>Полезные команды</a></li><li><a href=#сборка-образа>Сборка образа</a></li><li><a href=#работа-с-локальным-реджистри>Работа с локальным реджистри</a></li><li><a href=#docker-machine>Docker Machine</a></li></ul></nav></aside></main></body></html>