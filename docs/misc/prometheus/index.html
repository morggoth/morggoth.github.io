<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Основные понятия мониторинга #  Система мониторинга - набор инструментов, позволяющий снимать метрики со всех узлов инфраструктуры и сохранять их в единой базе для последующего анализа.
Метрика - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованнйо памяти и п.т.
Узел инфраструктуры - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.
Push model - агент отправляет метрики на центральный сервер системы мониторинга.
Pull model - центральный сервер самостоятельно опрашивает агентов."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Prometheus"><meta property="og:description" content="Основные понятия мониторинга #  Система мониторинга - набор инструментов, позволяющий снимать метрики со всех узлов инфраструктуры и сохранять их в единой базе для последующего анализа.
Метрика - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованнйо памяти и п.т.
Узел инфраструктуры - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.
Push model - агент отправляет метрики на центральный сервер системы мониторинга.
Pull model - центральный сервер самостоятельно опрашивает агентов."><meta property="og:type" content="article"><meta property="og:url" content="https://morggoth.github.io/docs/misc/prometheus/"><meta property="article:published_time" content="2021-03-31T00:02:58+03:00"><meta property="article:modified_time" content="2021-03-31T00:02:58+03:00"><title>Prometheus | Morggoth's wiki</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY="><script defer src=/en.search.min.624e0e6e114c530dc89b0c7ac945264f817a6429582ea9a87dd8b761e46f4049.js integrity="sha256-Yk4ObhFMUw3Imwx6yUUmT4F6ZClYLqmofdi3YeRvQEk="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>Morggoth's wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/cloud/ class=collapsed>Cloud</a></li><li><a href=/docs/k8s/ class=collapsed>Kubernetes</a></li><li><a href=/docs/mooc/ class=collapsed>Courses notes</a></li><li><a href=/docs/misc/prometheus/ class=active>Prometheus</a></li><li><a href=/docs/misc/docker/>Основы Docker</a></li><li><a href=/docs/misc/cheatsheets/>Cheatsheets</a></li><li><a href=/docs/misc/rpi/>Raspberry Pi</a></li><li><a href=/docs/misc/kafka/>Kafka basics</a></li><li><a href=/docs/misc/old_hardware/>Old hardware</a></li><li><a href=/docs/languages/ class=collapsed>Languages</a></li><li><a href=/docs/misc/chromeos/>ChromeOS</a></li><li><a href=/docs/misc/macos/>macOS</a></li><li><a href=/docs/misc/mikrotik/>Mikrotik</a></li><li><a href=/docs/misc/tips_and_tricks/>Tips & Tricks</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Prometheus</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#основные-понятия-мониторинга>Основные понятия мониторинга</a><ul><li><a href=#уровни-мониторинга>Уровни мониторинга</a></li></ul></li><li><a href=#задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга</a></li><li><a href=#ключевые-особенности-prometheus>Ключевые особенности Prometheus</a></li><li><a href=#архитектура>Архитектура</a></li><li><a href=#установка-prometheus>Установка Prometheus</a><ul><li><a href=#docker>Docker</a></li><li><a href=#ручная>Ручная</a></li></ul></li><li><a href=#экспортеры>Экспортеры</a></li><li><a href=#формат-метрик>Формат метрик</a></li></ul></nav></aside></header><article class=markdown><h2 id=основные-понятия-мониторинга>Основные понятия мониторинга
<a class=anchor href=#%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%bd%d1%8b%d0%b5-%d0%bf%d0%be%d0%bd%d1%8f%d1%82%d0%b8%d1%8f-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h2><p><em>Система мониторинга</em> - набор инструментов, позволяющий снимать <strong>метрики</strong> со всех <strong>узлов инфраструктуры</strong> и сохранять их в единой базе для последующего анализа.</p><p><em>Метрика</em> - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованнйо памяти и п.т.</p><p><em>Узел инфраструктуры</em> - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.</p><p><em>Push model</em> - агент отправляет метрики на центральный сервер системы мониторинга.</p><p><em>Pull model</em> - центральный сервер самостоятельно опрашивает агентов.</p><h3 id=уровни-мониторинга>Уровни мониторинга
<a class=anchor href=#%d1%83%d1%80%d0%be%d0%b2%d0%bd%d0%b8-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h3><ol><li>Системный - сбор метрик ОС и железа</li><li>Сервисный - то же самое для всех используемых сторонних сервисов, например БД, веб-серверов, систем оркестрации и т.д.</li><li>Приложения - монитогинг самописных приложений</li></ol><h2 id=задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга
<a class=anchor href=#%d0%b7%d0%b0%d0%b4%d0%b0%d1%87%d0%b8-%d1%80%d0%b5%d1%88%d0%b0%d0%b5%d0%bc%d1%8b%d0%b5-%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d0%be%d0%b9-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h2><ol><li>Оповещение о возникновении проблем.</li><li>Анализ инфраструктуры; прогнозирование потребности к масштабированию.</li><li>Предоставление исторических данных для расследования инцидентов.</li><li>Констроль оптимизации приложений.</li></ol><h2 id=ключевые-особенности-prometheus>Ключевые особенности Prometheus
<a class=anchor href=#%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%b2%d1%8b%d0%b5-%d0%be%d1%81%d0%be%d0%b1%d0%b5%d0%bd%d0%bd%d0%be%d1%81%d1%82%d0%b8-prometheus>#</a></h2><ol><li>Встроенная TSDB.</li><li>Multi-dimentional data model - в БД хранятся не только имена метрик, но и теги, привязанные к ним. Это позволяет создавать более гибкие выборки, что помогает при анализе.</li><li>PromQL - язык запросов ко встроенной TSDB.</li><li>Используется pull модель сбора метрик; сервер опрашивает агентов по HTTP с использованием собственного plain-text протокола.</li><li>Множество вариантов Service Discovery, что упрощает интеграцию с различными платформами.</li></ol><h2 id=архитектура>Архитектура
<a class=anchor href=#%d0%b0%d1%80%d1%85%d0%b8%d1%82%d0%b5%d0%ba%d1%82%d1%83%d1%80%d0%b0>#</a></h2><p><img src=/prom_architecture.png alt></p><p>Описание архитектуры в <a href=https://prometheus.io/docs/introduction/overview/#architecture>документации</a>.</p><p>Основные компоненты:</p><ol><li>Prometheus сервер, содержащий:</li></ol><ul><li>TSDB для хранения метрик</li><li>HTTP-сервер для работы web UI</li><li>модуль retrival, отвечающий за опрос агентов и получение от них метрик</li><li>модуль service discovery, определяющий цели для опроса метрик</li><li>модуль алертинга, отправляющий сообщения о проблемах в Alertmanager</li></ul><ol start=2><li>Exporters - агенты, устанавливаемые на узлах инфраструктуры, которые отдают метрики</li><li>Alertmanager - отдельный сервис, принимающий от Prometheus-сервера оповещения о проблемах и отправляющий их в соответствующие каналы (email, slack, telegram)</li><li>Дополнительные сервисы, такие как Grafana, котоыре могут подключаться к Prometheus и забирать из него данные для последющей обработки</li></ol><h2 id=установка-prometheus>Установка Prometheus
<a class=anchor href=#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-prometheus>#</a></h2><h3 id=docker>Docker
<a class=anchor href=#docker>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -p 9090:9090 -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
</code></pre></div><h3 id=ручная>Ручная
<a class=anchor href=#%d1%80%d1%83%d1%87%d0%bd%d0%b0%d1%8f>#</a></h3><ol><li>Скачиваем архив с <a href=https://prometheus.io/download/>официального сайта</a></li><li>Распаковываем содержимое и размещаем его по требуемым директориям</li><li>Создаём systemd unit и запускаем сервис</li></ol><details><summary>Пример unit-файла</summary><div class=markdown-inner><pre><code class=language-conf data-lang=conf>[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/prometheus \
    --config.file=/path/to/prometheus.yml \
    --storage.tsdb.path=/path/to/data \
    --web.console.templates=/path/to/consoles \
    --web.console.libraries=/path/to/console_libraries

[Install]
WantedBy=default.target
</code></pre></div></details><p>Основные файлы и директории архива:</p><ul><li>console_libraries/ - содержит библиотеки для HTML-шаблонов</li><li>consoles/ - содержит шаблоны HTML-страниц для web UI</li><li>prometheus - исполняемый файл сервера</li><li>prometheus.yml - его конфиг</li><li>promtool - утилита для проверки конфигурации, работы с TSDB и получения метрик</li></ul><details><summary>Основные параметры запуска:</summary><div class=markdown-inner><ul><li>&ndash;config.file=&ldquo;prometheus.yml&rdquo; - путь до конфига</li><li>&ndash;web.listen-address=&ldquo;0.0.0.0:9090&rdquo; - адрес, которые булеи слушать сервер</li><li>&ndash;web.enable-admin-api - включить или отключить административный API через веб-интерфейс</li><li>&ndash;web.console.templates=&ldquo;consoles&rdquo; - путь к директории с шаблонами html</li><li>&ndash;web.console.libraries=&ldquo;console_libraries&rdquo; - путь к директории с библиотеками для шаблонов</li><li>&ndash;web.page-title - заголовок веб-страницы (title)</li><li>&ndash;web.cors.origin=".*" - настройки CORS для веб-интерфейса</li><li>&ndash;storage.tsdb.path=&ldquo;data/&rdquo; - путь для хранения time series database</li><li>&ndash;storage.tsdb.retention.time - время хранения метрик по умолчанию 15 дней, все, что старше, будет удаляться</li><li>&ndash;storage.tsdb.retention.size - размер TSDB, после которого Prometheus начнет удалять самые старые данные</li><li>&ndash;query.max-concurrency - максимальное одновременное число запросов к Prometheus через PromQL</li><li>&ndash;query.timeout=2m - максимальное время выполнения одного запроса</li><li>&ndash;enable-feature - флаг для включения различных функций, описанных здесь</li><li>&ndash;log.level - уровень логирования</li></ul></div></details><h2 id=экспортеры>Экспортеры
<a class=anchor href=#%d1%8d%d0%ba%d1%81%d0%bf%d0%be%d1%80%d1%82%d0%b5%d1%80%d1%8b>#</a></h2><p>Принцип работы:</p><ul><li>прослущивает указанный в конфигурации порт на предмет входящих подключений</li><li>при поступлении запроса, опрашивает систему, которую он мониторит (например ОС в целом или конкретный сервис)</li><li>Prometheus обращается к экспортеру по заданному адресу с указанной периодичностью и получает в ответ все собранные метрики в текстовом формате</li><li>Prometheus сохраняет полученные данные в локальную TSDB</li></ul><p>Обычно экспортеры отдают метрики на <a href=http://exporter.url/metrics>http://exporter.url/metrics</a></p><p><a href=https://prometheus.io/docs/instrumenting/exporters/>Список экспортеров</a></p><p>Для сбора системных метрик в UNIX-like системах используется <em>node_exporter</em>. Собираемые им метрики группируются и собираются отдельными коллекторами, что позволяет гибко настраивать собираемые данные. К примеру, при запуске экспортера можно отключить сбор метрик ФС или CPU, если возникнет такая необходимость.</p><blockquote class="book-hint danger">(Официальная документация)[https://github.com/prometheus/node_exporter#docker] не рекомендует запускать node_exporter в Docker-контейнере, так как для его нормальнйо работы потребуется примонтировать все существующие ФС. Кроме того, ему нужен доступ к host-системе для сбора всех метрик.</blockquote><details><summary>Пример unit-файла</summary><div class=markdown-inner><pre><code class=language-conf data-lang=conf>[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=root
Group=root
Type=simple
ExecStart=/path/to/node_exporter

[Install]
WantedBy=multi-user.target
</code></pre></div></details><h2 id=формат-метрик>Формат метрик
<a class=anchor href=#%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82-%d0%bc%d0%b5%d1%82%d1%80%d0%b8%d0%ba>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>metric_name{tag1=&#34;key1&#34;, tag2=&#34;key2&#34;} X
</code></pre></div><p><em>metric_name</em> - имя метрики, используемое в запросах к Prometheus.</p><p>В фигурных скобках указына <em>теги</em> для данной метрики.</p><p><em>X</em> - здесь: текущее значение указанной метрики</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#основные-понятия-мониторинга>Основные понятия мониторинга</a><ul><li><a href=#уровни-мониторинга>Уровни мониторинга</a></li></ul></li><li><a href=#задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга</a></li><li><a href=#ключевые-особенности-prometheus>Ключевые особенности Prometheus</a></li><li><a href=#архитектура>Архитектура</a></li><li><a href=#установка-prometheus>Установка Prometheus</a><ul><li><a href=#docker>Docker</a></li><li><a href=#ручная>Ручная</a></li></ul></li><li><a href=#экспортеры>Экспортеры</a></li><li><a href=#формат-метрик>Формат метрик</a></li></ul></nav></aside></main></body></html>