<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Основные понятия мониторинга #  Система мониторинга - набор инструментов, позволяющий снимать метрики со всех узлов инфраструктуры и сохранять их в единой базе для последующего анализа.
Метрика - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованной памяти и п.т.
Узел инфраструктуры - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.
Push model - агент отправляет метрики на центральный сервер системы мониторинга.
Pull model - центральный сервер самостоятельно опрашивает агентов."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Prometheus"><meta property="og:description" content="Основные понятия мониторинга #  Система мониторинга - набор инструментов, позволяющий снимать метрики со всех узлов инфраструктуры и сохранять их в единой базе для последующего анализа.
Метрика - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованной памяти и п.т.
Узел инфраструктуры - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.
Push model - агент отправляет метрики на центральный сервер системы мониторинга.
Pull model - центральный сервер самостоятельно опрашивает агентов."><meta property="og:type" content="article"><meta property="og:url" content="https://morggoth.github.io/docs/misc/prometheus/"><meta property="article:published_time" content="2021-03-31T00:02:58+03:00"><meta property="article:modified_time" content="2021-03-31T00:02:58+03:00"><title>Prometheus | Morggoth's wiki</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY="><script defer src=/en.search.min.2afaa465622c0cbc8566fb90c81383dc0734008896325fb7197834ac3e7311e1.js integrity="sha256-KvqkZWIsDLyFZvuQyBOD3Ac0AIiWMl+3GXg0rD5zEeE="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>Morggoth's wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/cloud/ class=collapsed>Cloud</a></li><li><a href=/docs/k8s/ class=collapsed>Kubernetes</a></li><li><a href=/docs/mooc/ class=collapsed>Courses notes</a></li><li><a href=/docs/misc/prometheus/ class=active>Prometheus</a></li><li><a href=/docs/misc/docker/>Основы Docker</a></li><li><a href=/docs/misc/cheatsheets/>Cheatsheets</a></li><li><a href=/docs/misc/rpi/>Raspberry Pi</a></li><li><a href=/docs/misc/kafka/>Kafka basics</a></li><li><a href=/docs/misc/old_hardware/>Old hardware</a></li><li><a href=/docs/languages/ class=collapsed>Languages</a></li><li><a href=/docs/misc/chromeos/>ChromeOS</a></li><li><a href=/docs/misc/macos/>macOS</a></li><li><a href=/docs/misc/mikrotik/>Mikrotik</a></li><li><a href=/docs/misc/tips_and_tricks/>Tips & Tricks</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Prometheus</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#основные-понятия-мониторинга>Основные понятия мониторинга</a><ul><li><a href=#уровни-мониторинга>Уровни мониторинга</a></li></ul></li><li><a href=#задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга</a></li><li><a href=#ключевые-особенности-prometheus>Ключевые особенности Prometheus</a></li><li><a href=#архитектура>Архитектура</a></li><li><a href=#установка-prometheus>Установка Prometheus</a><ul><li><a href=#docker>Docker</a></li><li><a href=#ручная>Ручная</a></li></ul></li><li><a href=#экспортеры>Экспортеры</a></li><li><a href=#формат-метрик>Формат метрик</a></li><li><a href=#подключение-экспортера>Подключение экспортера</a></li><li><a href=#promql-запросы>PromQL запросы</a></li><li><a href=#мониторинг-приложений>Мониторинг приложений</a></li><li><a href=#приём-метрик-по-push-модели>Приём метрик по push модели</a><ul><li><a href=#установка-и-запуск>Установка и запуск</a></li><li><a href=#отправка-метрик-в-pushgateway>Отправка метрик в pushgateway</a></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=основные-понятия-мониторинга>Основные понятия мониторинга
<a class=anchor href=#%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%bd%d1%8b%d0%b5-%d0%bf%d0%be%d0%bd%d1%8f%d1%82%d0%b8%d1%8f-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h2><p><em>Система мониторинга</em> - набор инструментов, позволяющий снимать <strong>метрики</strong> со всех <strong>узлов инфраструктуры</strong> и сохранять их в единой базе для последующего анализа.</p><p><em>Метрика</em> - любой показатель, который тем или иным образом харектеризует систему, например показатель LA, количество использованной памяти и п.т.</p><p><em>Узел инфраструктуры</em> - любой используемый компонент, будь то сервер, ВМ или сетевое устройство.</p><p><em>Push model</em> - агент отправляет метрики на центральный сервер системы мониторинга.</p><p><em>Pull model</em> - центральный сервер самостоятельно опрашивает агентов.</p><p>Рассмотрение pull или push модели идет со стороны системы мониторинга.</p><h3 id=уровни-мониторинга>Уровни мониторинга
<a class=anchor href=#%d1%83%d1%80%d0%be%d0%b2%d0%bd%d0%b8-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h3><ol><li>Системный - сбор метрик ОС и железа</li><li>Сервисный - то же самое для всех используемых сторонних сервисов, например БД, веб-серверов, систем оркестрации и т.д.</li><li>Приложения - мониторинг самописных приложений</li></ol><h2 id=задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга
<a class=anchor href=#%d0%b7%d0%b0%d0%b4%d0%b0%d1%87%d0%b8-%d1%80%d0%b5%d1%88%d0%b0%d0%b5%d0%bc%d1%8b%d0%b5-%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d0%be%d0%b9-%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3%d0%b0>#</a></h2><ol><li>Оповещение о возникновении проблем.</li><li>Анализ инфраструктуры; прогнозирование потребности к масштабированию.</li><li>Предоставление исторических данных для расследования инцидентов.</li><li>Констроль оптимизации приложений.</li></ol><h2 id=ключевые-особенности-prometheus>Ключевые особенности Prometheus
<a class=anchor href=#%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%b2%d1%8b%d0%b5-%d0%be%d1%81%d0%be%d0%b1%d0%b5%d0%bd%d0%bd%d0%be%d1%81%d1%82%d0%b8-prometheus>#</a></h2><ol><li>Встроенная TSDB.</li><li>Multi-dimentional data model - в БД хранятся не только имена метрик, но и теги, привязанные к ним. Это позволяет создавать более гибкие выборки, что помогает при анализе.</li><li>PromQL - язык запросов ко встроенной TSDB.</li><li>Используется pull модель сбора метрик; сервер опрашивает агентов по HTTP с использованием собственного plain-text протокола.</li><li>Множество вариантов Service Discovery, что упрощает интеграцию с различными платформами.</li></ol><h2 id=архитектура>Архитектура
<a class=anchor href=#%d0%b0%d1%80%d1%85%d0%b8%d1%82%d0%b5%d0%ba%d1%82%d1%83%d1%80%d0%b0>#</a></h2><p><img src=/prom_architecture.png alt></p><p>Описание архитектуры в <a href=https://prometheus.io/docs/introduction/overview/#architecture>документации</a>.</p><p>Основные компоненты:</p><ol><li>Prometheus сервер, содержащий:</li></ol><ul><li>TSDB для хранения метрик</li><li>HTTP-сервер для работы web UI</li><li>модуль retrival, отвечающий за опрос агентов и получение от них метрик</li><li>модуль service discovery, определяющий цели для опроса метрик</li><li>модуль алертинга, отправляющий сообщения о проблемах в Alertmanager</li></ul><ol start=2><li>Exporters - агенты, устанавливаемые на узлах инфраструктуры, которые отдают метрики</li><li>Alertmanager - отдельный сервис, принимающий от Prometheus-сервера оповещения о проблемах и отправляющий их в соответствующие каналы (email, slack, telegram)</li><li>Дополнительные сервисы, такие как Grafana, которые могут подключаться к Prometheus и забирать из него данные для последующей обработки</li></ol><h2 id=установка-prometheus>Установка Prometheus
<a class=anchor href=#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-prometheus>#</a></h2><h3 id=docker>Docker
<a class=anchor href=#docker>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -p 9090:9090 -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
</code></pre></div><h3 id=ручная>Ручная
<a class=anchor href=#%d1%80%d1%83%d1%87%d0%bd%d0%b0%d1%8f>#</a></h3><ol><li>Скачиваем архив с <a href=https://prometheus.io/download/>официального сайта</a></li><li>Распаковываем содержимое и размещаем его по требуемым директориям</li><li>Создаём systemd unit и запускаем сервис</li></ol><details><summary>Пример unit-файла для Prometheus-сервера</summary><div class=markdown-inner><pre><code class=language-conf data-lang=conf>[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/prometheus \
    --config.file=/path/to/prometheus.yml \
    --storage.tsdb.path=/path/to/data \
    --web.console.templates=/path/to/consoles \
    --web.console.libraries=/path/to/console_libraries

[Install]
WantedBy=default.target
</code></pre></div></details><p>Основные файлы и директории архива:</p><ul><li>console_libraries/ - содержит библиотеки для HTML-шаблонов</li><li>consoles/ - содержит шаблоны HTML-страниц для web UI</li><li>prometheus - исполняемый файл сервера</li><li>prometheus.yml - его конфиг</li><li>promtool - утилита для проверки конфигурации, работы с TSDB и получения метрик</li></ul><details><summary>Основные параметры запуска Prometheus-сервера:</summary><div class=markdown-inner><ul><li>&ndash;config.file=&ldquo;prometheus.yml&rdquo; - путь до конфига</li><li>&ndash;web.listen-address=&ldquo;0.0.0.0:9090&rdquo; - адрес, которые булеи слушать сервер</li><li>&ndash;web.enable-admin-api - включить или отключить административный API через веб-интерфейс</li><li>&ndash;web.console.templates=&ldquo;consoles&rdquo; - путь к директории с шаблонами html</li><li>&ndash;web.console.libraries=&ldquo;console_libraries&rdquo; - путь к директории с библиотеками для шаблонов</li><li>&ndash;web.page-title - заголовок веб-страницы (title)</li><li>&ndash;web.cors.origin=".*" - настройки CORS для веб-интерфейса</li><li>&ndash;storage.tsdb.path=&ldquo;data/&rdquo; - путь для хранения time series database</li><li>&ndash;storage.tsdb.retention.time - время хранения метрик по умолчанию 15 дней, все, что старше, будет удаляться</li><li>&ndash;storage.tsdb.retention.size - размер TSDB, после которого Prometheus начнет удалять самые старые данные</li><li>&ndash;query.max-concurrency - максимальное одновременное число запросов к Prometheus через PromQL</li><li>&ndash;query.timeout=2m - максимальное время выполнения одного запроса</li><li>&ndash;enable-feature - флаг для включения различных функций, описанных здесь</li><li>&ndash;log.level - уровень логирования</li></ul></div></details><h2 id=экспортеры>Экспортеры
<a class=anchor href=#%d1%8d%d0%ba%d1%81%d0%bf%d0%be%d1%80%d1%82%d0%b5%d1%80%d1%8b>#</a></h2><p>Принцип работы:</p><ul><li>прослушивает указанный в конфигурации порт на предмет входящих подключений</li><li>при поступлении запроса, опрашивает систему, которую он мониторит (например ОС в целом или конкретный сервис)</li><li>Prometheus обращается к экспортеру по заданному адресу с указанной периодичностью и получает в ответ все собранные метрики в текстовом формате</li><li>Prometheus сохраняет полученные данные в локальную TSDB</li></ul><p>Обычно экспортеры отдают метрики на <a href=http://exporter.url/metrics>http://exporter.url/metrics</a></p><p><a href=https://prometheus.io/docs/instrumenting/exporters/>Список экспортеров</a></p><p>Для сбора системных метрик в UNIX-like системах используется <em>node_exporter</em>. Собираемые им метрики группируются и собираются отдельными коллекторами, что позволяет гибко настраивать собираемые данные. К примеру, при запуске экспортера можно отключить сбор метрик ФС или CPU, если возникнет такая необходимость.</p><blockquote class="book-hint danger"><a href=https://github.com/prometheus/node_exporter#docker>Официальная документация</a> не рекомендует запускать node_exporter в Docker-контейнере, так как для его нормальнйо работы потребуется примонтировать все существующие ФС. Кроме того, ему нужен доступ к host-системе для сбора всех метрик.</blockquote><details><summary>Пример unit-файла для _node\_exporter_</summary><div class=markdown-inner><pre><code class=language-conf data-lang=conf>[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=root
Group=root
Type=simple
ExecStart=/path/to/node_exporter

[Install]
WantedBy=multi-user.target
</code></pre></div></details><h2 id=формат-метрик>Формат метрик
<a class=anchor href=#%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82-%d0%bc%d0%b5%d1%82%d1%80%d0%b8%d0%ba>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>metric_name{tag1=&#34;key1&#34;, tag2=&#34;key2&#34;} X
</code></pre></div><p><em>metric_name</em> - имя метрики, используемое в запросах к Prometheus.</p><p>В фигурных скобках указына <em>теги</em> для данной метрики.</p><p><em>X</em> - здесь: текущее значение указанной метрики</p><h2 id=подключение-экспортера>Подключение экспортера
<a class=anchor href=#%d0%bf%d0%be%d0%b4%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%8d%d0%ba%d1%81%d0%bf%d0%be%d1%80%d1%82%d0%b5%d1%80%d0%b0>#</a></h2><p>Добавить новую цель для сбора метрик Prometheus&rsquo;ом можно через его конфиг. Ниже пример статической конфигурации:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>global</span>:
<span style=color:#75715e># there are global parameters of a Prometheus server in this section</span>
  <span style=color:#f92672>scrape_interval</span>:     <span style=color:#ae81ff>15s</span>

<span style=color:#f92672>scrape_configs</span>:
<span style=color:#75715e># there are scrape targets described in this section</span>

  <span style=color:#75715e># node_exporter target example</span>
  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;node&#39;</span>
    <span style=color:#75715e># redefine scrape_interval for a particular job</span>
    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9100&#39;</span>]
</code></pre></div><h2 id=promql-запросы>PromQL запросы
<a class=anchor href=#promql-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b>#</a></h2><p>Проверить корректность подключения Prometheus-сервера к экспортерам можно при помощи <em>promtool</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>promtool query instant http://localhost:9090 up
<span style=color:#75715e># up{instance=&#34;localhost:9100&#34;, job=&#34;node&#34;} =&gt; 1 @[1617970210.143]</span>
</code></pre></div><p>При помощи <em>promtool</em> можно выполнять произвольные запросы к встроенной TSBD, например:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>promtool query instant http://localhost:9090 <span style=color:#e6db74>&#39;node_disk_written_bytes_total&#39;</span>
<span style=color:#75715e># node_disk_written_bytes_total{device=&#34;vda&#34;, instance=&#34;localhost:9100&#34;, job=&#34;node&#34;} =&gt; 52323148800 @[1617970275.39]</span>
</code></pre></div><p>Помимо тегов, отдаваемых непосредственно экспортером, Prometheus перед записью метрик в TSDB также добавляет собственные:</p><ul><li>instance - адрес экспортера, с которого получена метрика</li><li>job - имя задания из, указанное в конфиге сервера</li></ul><p>При необходимости можно добавить кастомные теги для каждой цели:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;node&#39;</span>
    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9100&#39;</span>]
        <span style=color:#f92672>labels</span>:
          <span style=color:#f92672>env</span>: <span style=color:#e6db74>&#39;dev&#39;</span>
</code></pre></div><p>Теперь метрики с этого из этой группы экспортеров будут содержать кастомный тег:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>promtool query instant http://localhost:9090 <span style=color:#e6db74>&#39;node_disk_written_bytes_total&#39;</span>
<span style=color:#75715e># node_disk_written_bytes_total{device=&#34;vda&#34;, env=&#34;dev&#34;, instance=&#34;localhost:9100&#34;, job=&#34;node&#34;} =&gt; 52338947072 @[1617970356.777]</span>
</code></pre></div><p>Получить данные за определенный промежуток времени можно указав его в квадратных скобках после запроса:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>promtool query instant http://localhost:9090 <span style=color:#e6db74>&#39;node_disk_written_bytes_total{env=&#34;dev&#34;}[1m]&#39;</span>
</code></pre></div><h2 id=мониторинг-приложений>Мониторинг приложений
<a class=anchor href=#%d0%bc%d0%be%d0%bd%d0%b8%d1%82%d0%be%d1%80%d0%b8%d0%bd%d0%b3-%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b9>#</a></h2><p>Существует множество как официальных, так и поддерживаемых сторонними разработчиками клиентских <a href=https://prometheus.io/docs/instrumenting/clientlibs/>библиотек</a> для имплементации Prometheus экспортеров. Это позволяет относительно просто добавить возможность собирать метрики непосредственно из приложения.</p><div class=book-tabs><input type=radio class=toggle name=tabs-uniqueid id=tabs-uniqueid-0 checked>
<label for=tabs-uniqueid-0>Go</label><div class="book-tabs-content markdown-inner"><p><a href=https://prometheus.io/docs/guides/go-application/>Описание библиотеки</a></p><p><a href=https://github.com/prometheus/client_golang>Github</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p app/src/app
cd app/src/app
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
        <span style=color:#e6db74>&#34;net/http&#34;</span>

        <span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/metrics&#34;</span>, <span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>Handler</span>())
        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:2112&#34;</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export GOPATH<span style=color:#f92672>=</span>/path/to/app
go mod init
go get
go build main.go
./main

curl localhost:2112
</code></pre></div></div><input type=radio class=toggle name=tabs-uniqueid id=tabs-uniqueid-1>
<label for=tabs-uniqueid-1>Python</label><div class="book-tabs-content markdown-inner"><p><a href=https://github.com/prometheus/client_python>Библиотека</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python3 -m venv .venv
source .venv/bin/activate
pip install prometheus-client
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> prometheus_client <span style=color:#f92672>import</span> start_http_server, Summary
<span style=color:#f92672>import</span> random
<span style=color:#f92672>import</span> time

<span style=color:#75715e># Create a metric to track time spent and requests made.</span>
REQUEST_TIME <span style=color:#f92672>=</span> Summary(<span style=color:#e6db74>&#39;request_processing_seconds&#39;</span>, <span style=color:#e6db74>&#39;Time spent processing request&#39;</span>)

<span style=color:#75715e># Decorate function with metric.</span>
<span style=color:#a6e22e>@REQUEST_TIME.time</span>()
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>process_request</span>(t):
    <span style=color:#e6db74>&#34;&#34;&#34;A dummy function that takes some time.&#34;&#34;&#34;</span>
    time<span style=color:#f92672>.</span>sleep(t)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    <span style=color:#75715e># Start up the server to expose the metrics.</span>
    start_http_server(<span style=color:#ae81ff>8000</span>)
    <span style=color:#75715e># Generate some requests.</span>
    <span style=color:#66d9ef>while</span> True:
        process_request(random<span style=color:#f92672>.</span>random())
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python app.py
curl localhost:8000
</code></pre></div></div></div><p>Дополнительные материалы:</p><ul><li><a href=https://blog.alexellis.io/prometheus-monitoring/>Monitoring apps with prometheus</a></li><li><a href=https://habr.com/ru/post/420633/>Пишем собственный экспортер для Prometheus</a></li></ul><h2 id=приём-метрик-по-push-модели>Приём метрик по push модели
<a class=anchor href=#%d0%bf%d1%80%d0%b8%d1%91%d0%bc-%d0%bc%d0%b5%d1%82%d1%80%d0%b8%d0%ba-%d0%bf%d0%be-push-%d0%bc%d0%be%d0%b4%d0%b5%d0%bb%d0%b8>#</a></h2><p>Несмотря на то, что по умолчанию Prometheus работает по pull модели, вместе с ним можно воспользоваться и push моделью. Для её реализации существует специальный экспортер - <em>pushgateway</em>.</p><p>Push-архитектура может быть применена, в случае, когда нам нужно собрать метрики с короткоживущего объекта. Таким объектом может быть, например, задание cron или, скажем, ETL-процесс, для которого важны итоговые метрики.</p><p>Официальное <a href=https://prometheus.io/docs/practices/pushing/>описание</a> случаев, для которых следует применять <em>pushgateway</em>.</p><h3 id=установка-и-запуск>Установка и запуск
<a class=anchor href=#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-%d0%b8-%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba>#</a></h3><p>Установка в целом такая же, как и у других компонентов.</p><p><a href=https://github.com/prometheus/pushgateway/releases>Страница</a>, где можно скачать релиз для ручной установки.</p><p>В качестве (предпочтительной) альтернативы можно воспользоваться Docker:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -d -p 9091:9091 prom/pushgateway
</code></pre></div><details><summary>Основные параметры запуска _pushgateway_:</summary><div class=markdown-inner><ul><li>&ndash;web.config.file="" - Экспериментальная опция, позволяющая указать путь к конфигурации для включения TLS при обработке запросов.</li><li>&ndash;web.listen-address=":9091" - адрес, на котором pushgateway будет ожидать входящих подключений.</li><li>&ndash;web.telemetry-path="/metrics" - путь, по которому будут доступны метрики для Prometheus.</li><li>&ndash;web.enable-lifecycle - разрешает выключать pushgateway через запрос API.</li><li>&ndash;web.enable-admin-api - включает административный API, с помощью которого на данный момент можно только удалить все метрики.</li><li>&ndash;persistence.file="" - файл, в котором pushgateway будет сохранять полученные метрики. По умолчанию они хранятся в памяти и теряются при рестарте.</li><li>&ndash;persistence.interval=5m - как часто следует сохранять метрики в файл.</li></ul></div></details><h3 id=отправка-метрик-в-pushgateway>Отправка метрик в pushgateway
<a class=anchor href=#%d0%be%d1%82%d0%bf%d1%80%d0%b0%d0%b2%d0%ba%d0%b0-%d0%bc%d0%b5%d1%82%d1%80%d0%b8%d0%ba-%d0%b2-pushgateway>#</a></h3><p>По умолчанию <em>pushgateway</em> слушает на порту 9091 и имеет собственный web UI.</p><p>Алгоритм работы:</p><ul><li>метрика отправляется в <em>pushgateway</em> через HTTP API</li><li><em>pushgateway</em> добавляется в качестве одной из целей Prometheus-сервера</li><li>Prometheus-сервер забирает метрики из <em>pushgateway</em> при обращении к стандартному эндпоинту <code>/metrics</code>.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#34;cron_app_processed_users 112&#34;</span> | curl --data-binary @- http://localhost:9091/metrics/job/cron_app
echo <span style=color:#e6db74>&#34;cron_app_payed_sum 13423&#34;</span> | curl --data-binary @- http://localhost:9091/metrics/job/cron_app
</code></pre></div><p>Флаг <code>--data-binary</code> отправляет полученные данные POST-ззапросом как есть, никак их не изменяя.</p><p>Стоит отметить сообенность формирования URL: <code>job</code> - это лейбл, а <code>cron_app</code> - его значение. По этому тегу <em>pushgateway</em> будет группировать метрики.</p><p>При запросе метрики будут выглядеть так:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl http://localhost:9091/metrics
<span style=color:#75715e># TYPE cron_app_payed_sum untyped</span>
cron_app_payed_sum<span style=color:#f92672>{</span>instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cron_app&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>13423</span>
<span style=color:#75715e># TYPE cron_app_processed_users untyped</span>
cron_app_processed_users<span style=color:#f92672>{</span>instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cron_app&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>112</span>

... skipped ...

<span style=color:#75715e># HELP push_failure_time_seconds Last Unix time when changing this group in the Pushgateway failed.</span>
<span style=color:#75715e># TYPE push_failure_time_seconds gauge</span>
push_failure_time_seconds<span style=color:#f92672>{</span>instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cron_app&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>0</span>
<span style=color:#75715e># HELP push_time_seconds Last Unix time when changing this group in the Pushgateway succeeded.</span>
<span style=color:#75715e># TYPE push_time_seconds gauge</span>
push_time_seconds<span style=color:#f92672>{</span>instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cron_app&#34;</span><span style=color:#f92672>}</span> 1.6208582543334155e+09

... skipped ...
</code></pre></div><p>Последние две метрики:</p><ul><li>push_failure_time_seconds - время, когда последний раз провалилась запись в эту группу</li><li>push_time_seconds - время последней успешной записи</li></ul><p>Их можно использовать для отслеживания самого факта отправки метрик.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#основные-понятия-мониторинга>Основные понятия мониторинга</a><ul><li><a href=#уровни-мониторинга>Уровни мониторинга</a></li></ul></li><li><a href=#задачи-решаемые-системой-мониторинга>Задачи, решаемые системой мониторинга</a></li><li><a href=#ключевые-особенности-prometheus>Ключевые особенности Prometheus</a></li><li><a href=#архитектура>Архитектура</a></li><li><a href=#установка-prometheus>Установка Prometheus</a><ul><li><a href=#docker>Docker</a></li><li><a href=#ручная>Ручная</a></li></ul></li><li><a href=#экспортеры>Экспортеры</a></li><li><a href=#формат-метрик>Формат метрик</a></li><li><a href=#подключение-экспортера>Подключение экспортера</a></li><li><a href=#promql-запросы>PromQL запросы</a></li><li><a href=#мониторинг-приложений>Мониторинг приложений</a></li><li><a href=#приём-метрик-по-push-модели>Приём метрик по push модели</a><ul><li><a href=#установка-и-запуск>Установка и запуск</a></li><li><a href=#отправка-метрик-в-pushgateway>Отправка метрик в pushgateway</a></li></ul></li></ul></nav></aside></main></body></html>